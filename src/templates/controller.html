{% extends 'base.html' %}

{% block sidebar %}
<ul class="nav nav-pills nav-stacked">

{% for endpoint,title in [('controller', 'Controller')] %}
    <li{{ ' class="active"'|safe if endpoint==request.url_rule.endpoint else '' }}><a href="{{ url_for(endpoint) }}">{{ title }}</a></li>
{% endfor %}
</ul>

{% endblock %}

{% block main %}
<h3>Controller</h3>

<div class="btn-toolbar">
    <div class="btn-group">
        <button class="btn btn-success" id="controller-start"><i class="fa fa-play"></i> Start</button>
        <button class="btn btn-danger" id="controller-stop"><i class="fa fa-stop"></i> Stop</button>
        <button class="btn btn-primary" id="controller-restart"><i class="fa fa-refresh"></i> Restart</button>
    </div>
    <div class="btn-group">
        <button class="btn btn-default" id="clear-log">Clear log</button>
    </div>
</div><br>

<div class="well" id="log-area" style="height:400px; overflow:auto"></div>

{% endblock %}

{% block scripts %}
<script>

function logmessage(e){
        var msg = $.parseJSON(e.data);
        if(msg.level == 'STATECHANGE')
            return

        var icons = {
            'DEBUG': 'fa fa-fw fa-check',
            'INFO': 'fa fa-fw fa-info',
            'ERROR': 'fa fa-fw fa-exclamation',
            'WARNING': 'fa fa-fw fa-warning',
            'CRITICAL': 'fa fa-fw fa fa-bomb'
        };

        var date = new Date(msg.time*1000);
        var h = ('0'+date.getHours()).slice(-2);
        var m = ('0'+date.getMinutes()).slice(-2);
        var s = ('0'+date.getSeconds()).slice(-2);

        var time = h+':'+m+':'+s;

        $('#log-area').append(
            $('<div>').append(
                $('<i>').addClass(icons[msg.level])
                    .attr('title', time)
                    .tooltip({placement:'left'})
            ).append(msg.message)
        );

        $('#log-area').animate({
            scrollTop: $('#log-area').get(0).scrollHeight
        }, 'fast');

    }
stream.addEventListener('message', logmessage, false);

$(function(){

    $('#controller-start').on('click', function(){
        $.get('{{ url_for('controller_start') }}');
    });

    $('#controller-stop').on('click', function(){
        $.get('{{ url_for('controller_stop') }}');
    });

    $('#controller-restart').on('click', function(){
        $.get('{{ url_for('controller_restart') }}');
    });

    $('#clear-log').on('click', function(){
        $('#log-area').empty();
    });


})
</script>

{% endblock %}